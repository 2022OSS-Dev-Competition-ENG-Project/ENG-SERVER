<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.managerservice.mapper.FacilityMapper">

    <resultMap type="com.example.managerservice.dto.FacilityDto" id="facilityInfo" >
        <result property="facility_no" column="facilityNo"/>
        <result property="mg_user_uuid" column="userId"/>
        <result property="facility_name" column="facilityName"/>
        <result property="facility_address" column="facilityAddress"/>
        <result property="facility_qr_code" column="facilityQrCode"/>
    </resultMap>

    <resultMap type="com.example.managerservice.dto.FacilityJoinDto" id="facilityJoinUser">
        <result property="user_uuid" column="userUuid"/>
        <result property="user_facility" column="userFacility"/>
    </resultMap>

    <resultMap type="com.example.managerservice.vo.GetMyFacilityList" id="facilityList">
        <result property="user_uuid" column="userUuid"/>
        <result property="facility_address" column="facilityAddress"/>
        <result property="user_facility" column="userFacility"/>
        <result property="facility_name" column="facilityName"/>

    </resultMap>

    <insert id="registerFacility" parameterType="com.example.managerservice.dto.FacilityDto">
        INSERT INTO facility (
            facility_no,
            mg_user_uuid,
            facility_name,
            facility_address,
            facility_qr_code
        )
        values (
                    #{facilityNo},
                    #{userId},
                    #{facilityName},
                    #{facilityAddress},
                    #{facilityQrCode}
               )
    </insert>


    <select id="findDetailFacilityAd" resultMap="facilityInfo">
        SELECT *
        FROM facility
        WHERE facility_address = #{facilityAddress}
    </select>

    <select id="findDetailFacilityFn" resultMap="facilityInfo">
        SELECT *
        FROM facility
        WHERE facility_no = #{facilityNo}
    </select>

    <select id="nameAndAddressToDto" resultMap="facilityInfo">
        <![CDATA[
        SELECT *
        FROM facility
        WHERE facility_name = #{facilityName} AND facility_address = #{facilityAddress}
        ]]>
    </select>

    <insert id="facilityUserJoin" parameterType="com.example.managerservice.dto.FacilityJoinDto">
        INSERT INTO user_use_facility(
            user_uuid,
            user_facility
        )VALUES (
                   #{userUuid},
                   #{userFacility}
               )
    </insert>

    <!-- 시설 아이디로 시설 등록 중복 검증 -->
    <select id="findDetailFacilityId" resultType="java.lang.Integer">
        select if(count(*) = 1, 1, 0)
        from user_use_facility
        where user_facility = #{userFacility} AND user_uuid = #{userUuid}
    </select>

    <!-- 내가 등록한 시설물 불러오기 -->
    <select id="getMyFacilityList" resultMap="facilityList">
        select uuf.user_uuid,
               uuf.user_facility,
               f.facility_name ,
               f.facility_address
        From(
            select * from user_use_facility
            where user_uuid = #{userUuid}
            ) as uuf
            INNER JOIN
                facility f
            ON
            uuf.user_facility  = f.facility_no ;
    </select>

    <!-- 내가 등록한 시설물 삭제 -->
    <delete id="deleteMyFacility">
        delete
        from user_use_facility
        where user_uuid = #{userUuid} AND user_facility = #{userFacility};
    </delete>

    <!-- 좋이요 -->
    <update id="myFacilityLike">
        update liked_bool
        from user_use_facility
        set liked_bool = ${value}
    </update>

    <select id="myFacilityLikeBool" resultType="java.lang.Integer">
        select if(liked_bool >= 1, 1, 0)
        from user_use_facility
        where user_uuid = #{userUuid} AND user_facility = #{userFacility}
    </select>



</mapper>